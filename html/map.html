<html>
<head>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.vectorgrid@1.2.0"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<style type="text/css">
.tree-name {
  font-weight: bold
}
</style>
</head>
<body>
<script>
var MAPBOX_URL = 'https://api.mapbox.com/styles/v1/mapbox/light-v9/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoiYW5kcmV3ZWxhbmQiLCJhIjoiWFQxTW5HdyJ9.nmZbHHvtnEQHP8iy9ibtQg';
var WIDTH = 1000, HEIGHT = 1000;
var CENTER = L.latLng(51.549180, -0.140962);
var options = {
  dragging: true,
  touchZoom: false,
  scrollWheelZoom: false,
  zoomControl: true,
  attributionControl: false
};
var div = d3.select('body').append('div')
  .attr('id', 'map')
  .attr('style', 'width: ' + WIDTH + 'px; height: ' + HEIGHT + 'px;');
var map = L.map('map', options).setView([CENTER.lat, CENTER.lng], 16);
L.tileLayer(MAPBOX_URL).addTo(map);

metersToPixels = function(map, meters) {
  centerLatLng = map.getCenter();
  centerPoint = map.latLngToContainerPoint(centerLatLng);
  deltaLatLng = map.containerPointToLatLng(L.point(centerPoint.x + 1, centerPoint.y));
  metersPerPixel = centerLatLng.distanceTo(deltaLatLng);
  return meters / metersPerPixel;
}

treeColors = {
  'London plane': '#84903a',
  'False Acacia': '#b1c061',
  'Cherry': '#ffbdd4',
  'Cherry - Rosebud': '#ffbdd4',
  'Cherry - Wild, Gean': '#ffbdd4',
}

vectorTileOptions = {
  interactive: true,
  vectorTileLayerStyles: {
    trees: function(properties, zoom) {
      color = treeColors[properties.name] || '#41ab5d'
      return {
        radius: metersToPixels(map, properties.spread),
        stroke: true,
        weight: 1,
        fill: true,
        color: color,
        fillColor: color,
        fillOpacity: 0.5,
      }
    },
  },
};
layer = L.vectorGrid.protobuf('/tile/{z}/{x}/{y}.mvt', vectorTileOptions)
var highlight
layer.on('mouseover', function(e) {
  console.log(e);
  if (!e.layer.properties.spread) {
    return
  }
  if (highlight) {
    highlight.removeFrom(map)
  }
  msg = e.layer.properties.name
  if (e.layer.properties.height) {
    msg = e.layer.properties.height + 'm ' + msg
  }
  highlight = L.marker(e.latlng, {icon: L.divIcon({
    html: msg,
    className: 'tree-name',
    iconSize: [200, 50],
    iconAnchor: [-15, 0],
  })})
  highlight.addTo(map);
  L.DomEvent.stop(e);
})
layer.on('mouseout', function(e) {
  if (highlight) {
    highlight.removeFrom(map)
  }
})
layer.addTo(map);
</script>
</body>
</html>
