<html>
<head>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.vectorgrid@1.2.0"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
</head>
<body>
<script>
var MAPBOX_URL = 'https://api.mapbox.com/styles/v1/mapbox/light-v9/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoiYW5kcmV3ZWxhbmQiLCJhIjoiWFQxTW5HdyJ9.nmZbHHvtnEQHP8iy9ibtQg';
var WIDTH = 1000, HEIGHT = 1000;
var CENTER = L.latLng(51.549180, -0.140962);
var options = {
  dragging: true,
  touchZoom: false,
  scrollWheelZoom: false,
  zoomControl: true,
  attributionControl: false
};
var div = d3.select('body').append('div')
  .attr('id', 'map')
  .attr('style', 'width: ' + WIDTH + 'px; height: ' + HEIGHT + 'px;');
var map = L.map('map', options).setView([CENTER.lat, CENTER.lng], 16);
L.tileLayer(MAPBOX_URL).addTo(map);
metersToPixels = function(map, meters) {
  centerLatLng = map.getCenter();
  centerPoint = map.latLngToContainerPoint(centerLatLng);
  deltaLatLng = map.containerPointToLatLng(L.point(centerPoint.x + 1, centerPoint.y));
  metersPerPixel = centerLatLng.distanceTo(deltaLatLng);
  return meters / metersPerPixel;
}

vectorTileOptions = {
  vectorTileLayerStyles: {
    trees: function(properties, zoom) {
      return {
        radius: metersToPixels(map, properties.spread),
        stroke: true,
        fill: false,
        color: "#00ff00",
        fillColor: "#00ff00",
        fillOpacity: 1.0,
      }
    },
    estates: function(properties, zoom) {
      return {
        radius: 5,
        stroke: true,
        fill: false,
        color: "#ff0000",
        fillColor: "#ff0000",
        fillOpacity: 1.0,
      }
    },
  },
};
L.vectorGrid.protobuf("/tile/{z}/{x}/{y}.mvt", vectorTileOptions).addTo(map);

var degressPerMeter = 1.0 / L.CRS.Earth.distance(L.latLng(0, 0), L.latLng(0, 1));

d3.json("output.geojson", function(error, geoJSON) {
  L.geoJSON(geoJSON, {
    pointToLayer: function(point, latLng) {
      var group = L.layerGroup();
      var l = Math.floor(Math.sqrt(point.properties.total));
      var x = 0, y = 0;
      for (i = 0; i < point.properties.total; i++) {
        newLatLng = L.latLng(latLng.lat - (y * 15.0 * degressPerMeter), latLng.lng +  (x * 15.0 * degressPerMeter))
        color = '#ff0000'
        if (i < point.properties.newBuild) {
          color = '#ffb000'
        }
        group.addLayer(L.circle(newLatLng, {
          radius: 3,
          stroke: true,
          fill: true,
          color: color,
          fillColor: color,
          fillOpacity: 1.0,
        }))
        x++
        if (x > l) {
          x = 0
          y++
        }
      }
      return group
    },
  }); //.addTo(map);
});
</script>
</body>
</html>
